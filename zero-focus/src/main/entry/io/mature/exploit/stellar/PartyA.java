package io.mature.exploit.stellar;

import io.horizon.eon.em.Environment;
import io.horizon.eon.spec.VWeb;
import io.horizon.uca.cache.Cc;
import io.macrocosm.specification.program.HArk;
import io.mature.exploit.stellar.vendor.OkB;
import io.modello.atom.app.KGlobal;
import io.vertx.core.json.JsonObject;
import io.vertx.up.commune.config.Database;
import io.vertx.up.util.Ut;

/**
 * @author <a href="http://www.origin-x.cn">Lang</a>
 */
public class PartyA implements OkA {
    private final transient Environment environment;
    private final transient OkA ok;
    private final Cc<String, Database> CC_DB = Cc.open();

    private PartyA(final OkA ok, final Environment environment) {
        this.environment = environment;
        this.ok = ok;
    }

    public static OkA create(final OkA ok, final Environment environment) {
        return new PartyA(ok, environment);
    }

    @Override
    public boolean initialized() {
        return this.ok.initialized();
    }

    @Override
    public KGlobal partyA() {
        return this.ok.partyA().copy();
    }

    @Override
    public OkB partyB(final String name) {
        final OkB okB = this.ok.partyB(name).copy();
        final String path = VWeb.runtime.environment.ofIntegration(this.environment);
        final JsonObject item = Ut.ioJObject(path + name + ".json");
        if (Ut.isNotNil(item)) {
            okB.configIntegration().fromJson(item);
            okB.configIntegration().mockOn();
        }
        return okB;
    }

    @Override
    public Database configDatabase() {
        final Database configDatabase = this.ok.configDatabase();
        return this.CC_DB.pick(() -> {
            final Database database = this.ok.configDatabase().copy();
            final String path = VWeb.runtime.environment.ofDatabase(this.environment);
            final JsonObject item = Ut.ioJObject(path);
            if (Ut.isNotNil(item)) {
                database.fromJson(item);
            }
            return database;
        }, configDatabase.getJdbcUrl());
    }

    @Override
    public HArk configApp() {
        return this.ok.configApp();
    }
}
